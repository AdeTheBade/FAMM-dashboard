name: Weekly ASM Detection

on:
  schedule:
    - cron: "0 20 * * 6"    # 8 PM UTC = 9 PM WAT, every Saturday
  workflow_dispatch:          # allow manual trigger for testing

permissions:
  contents: write             # needed to push the updated GeoJSON back
  id-token: write             # needed for Workload Identity Federation

jobs:
  detect-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 100      # EE export (up to 55 min) + inference (~10 min) + buffer

    steps:

      # â”€â”€ 1. Checkout dashboard repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout dashboard repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # â”€â”€ 2. Checkout org ML repo (model weights + boundary files) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout FAMM org repo
        uses: actions/checkout@v4
        with:
          repository: projects-hamoye-org/FAMM
          token: ${{ secrets.GH_PAT }}
          path: famm-model

      # â”€â”€ 3. Set up Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # â”€â”€ 4. Cache pip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-famm-v2

      # â”€â”€ 5. Install dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Python dependencies
        run: |
          pip install \
            earthengine-api==1.6.12 \
            google-auth==2.41.1 \
            google-auth-httplib2==0.2.0 \
            google-api-python-client==2.184.0 \
            rasterio==1.4.3 \
            geopandas==1.1.2 \
            torch==2.1.0 \
            torchvision==0.16.0 \
            tqdm==4.67.1 \
            shapely==2.1.2 \
            numpy==1.26.3

      # â”€â”€ 6. Authenticate to Google Cloud via WIF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # â”€â”€ 7. Set up Cloud SDK (optional but helps with diagnostics) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # â”€â”€ 8. Stage model artifacts from org repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Stage model artifacts
        run: |
          mkdir -p deployment models data/tif_input data/geojson

          cp famm-model/deployment/geoBoundaries-GHA-ADM1.geojson deployment/
          cp famm-model/deployment/geoBoundaries-GHA-ADM2.geojson deployment/
          cp famm-model/models/mobilenetv3_best.pth               models/

          echo "âœ… Model artifacts staged"
          ls -lh models/ deployment/

      # â”€â”€ 9. Export composite from Earth Engine â†’ Drive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Export Sentinel-2 composite (EE â†’ Drive)
        run: |
          OUTPUT=$(python ee_export_drive_wif.py 2>&1)
          echo "$OUTPUT"

          EXPORT_FILENAME=$(echo "$OUTPUT" | grep "^EXPORT_FILENAME=" | cut -d= -f2)
          if [ -z "$EXPORT_FILENAME" ]; then
            echo "âŒ Could not extract export filename. Check EE logs above."
            exit 1
          fi
          echo "EXPORT_FILENAME=$EXPORT_FILENAME" >> $GITHUB_ENV
          echo "âœ… Export complete: $EXPORT_FILENAME"

      # â”€â”€ 10. Verify .tif was downloaded by ee_export_drive_wif.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # (the export script handles the download itself â€” this step just confirms)
      - name: Verify .tif downloaded
        run: |
          TIF_PATH="data/tif_input/${{ env.EXPORT_FILENAME }}"
          if [ ! -f "$TIF_PATH" ]; then
            echo "âŒ Expected .tif not found at: $TIF_PATH"
            exit 1
          fi
          SIZE=$(du -h "$TIF_PATH" | cut -f1)
          echo "âœ… .tif confirmed at $TIF_PATH ($SIZE)"

      # â”€â”€ 11. Run MobileNet V3 inference â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run inference
        run: python run_inference.py

      # â”€â”€ 12. Validate and clean GeoJSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validate and clean GeoJSON
        run: |
          python validate_rosemary_geojson.py \
            asm_monitoring_results.geojson \
            data/geojson/latest_detections.geojson

      # â”€â”€ 13. Commit updated detections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit updated detections
        run: |
          git config user.name  "FAMM Bot ğŸ¤–"
          git config user.email "famm-bot@users.noreply.github.com"

          git add data/geojson/latest_detections.geojson

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes in detections â€” nothing to commit this week."
          else
            COUNT=$(python -c "
          import json
          with open('data/geojson/latest_detections.geojson') as f:
              print(len(json.load(f).get('features', [])))
          ")
            git commit -m "chore: weekly detection update $(date -u '+%Y-%m-%d') â€” ${COUNT} sites detected"
            git push
            echo "âœ… Pushed â€” Streamlit Cloud will auto-redeploy"
          fi

      # â”€â”€ 14. Cleanup temporary files (never committed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cleanup
        if: always()
        run: |
          rm -rf data/tif_input/
          rm -f  asm_monitoring_results.geojson
          echo "ğŸ§¹ Temp files cleaned"
